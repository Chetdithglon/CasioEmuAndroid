#include "Injector.hpp"
#include "../Chipset/Chipset.hpp"
#include "../Peripheral/BatteryBackedRAM.hpp"
#include "hex.hpp"
#include "imgui/imgui.h"
#include "../Models.h"
#include <cstdlib>
#include <cstring>
#include <string>
#include "../Config.hpp"
#include "ui.hpp"
#include "UIScaling.h"
#include <filesystem>
#include <fstream>
#include <iostream>
#include <vector>
#include <algorithm>
#include <sstream>

struct InjectEntry {
    char address[10];
    char hexData[65536];
};

struct PresetInject {
    const char* name;
    std::vector<std::pair<uint32_t, std::string>> injects;
};

void Injector::RenderCore() {
    UI::Scaling::UpdateUIScale();

    static float scale = -1.0f;
    static int range = 64;
    static char strbuf[65536] = {0};
    static char buf[10] = {0};
    static char buf2[10] = {0};
    static MemoryEditor editor;
    static const char* info_msg = nullptr;
    static bool show_info_popup = false;
    auto inputbase = m_emu->hardware_id == casioemu::HardwareId::HW_CLASSWIZ_II ? 0x9268 : 0xD180;
    char* base_addr = n_ram_buffer - casioemu::GetRamBaseAddr(m_emu->hardware_id);
    static std::vector<InjectEntry> injectEntries;

    static const std::vector<PresetInject> presets = {
        {
            "Small Font[124an]",
            {
                {0xd180, "3030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030307ad832"}
            }
        },
        {
            "QuickCpy++[124an]",
            {
                {0xd8a0, "30300130300130022ED980D190AC3030303002753130CCD830303E9D303030"},
                {0xd8c0, "A09C30303030C0303616323030EA800E313087D930303030A89F3030BC6E3130"},
                {0xd8e0, "30302E623130FAEF5A30D20332302E623130A0EFA0D8E6BFA0EF"},
                {0xd180, "3030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030302E62313011D10230D20332302E623130A0EFA0D8620D3230A0EFE6BF30305A"}
            }
        },
        {
            "Draw One Color[124an]",
            {
                {0xe9e0, "0000303130300107D3E3311830DA30303030303030307A017E9430DA02263130A2D54EF23130DA7B31301030303030300130CC033230800E313030D530303030509930303030AE1B3230A6A830300ED6A59C30306CD63030A59C303098D63030A59C3030303030300226313090DA90C73030748931305E30A650323008D68E3B3130084032303030303030303030741F323080EB74893130E0E90226313076D5509430300200A09C3030303030304AD0303030300840323054D6303030303030347B313030303130A650323078D5A59C30303030303074893130E2E93289B2000100785C313082D53616323076D5D29030307489313030300226313030DB90C73030748931303C30A650323098D68E3B3130084032303030303030303030741F32303030748931300000A09C303080EB3030A09C3030CCD63030DA7B31303030313078D590D5A59C30303030303074893130E2E932893A003030741F323002D7347B3130D4DD0006369D30307E943030DA7B31303030313078D590D5A59C30303030303074893130E2E9328908003030741F323000000000000000000000000000000000000000000000000000000000"},
                {0xda70, "80"},
                {0xdaa4, "ffff"},
                {0xdaa9, "ff"},
                {0xdae8, "01"},
                {0xdae5, "01"},
                {0xd180, "303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030DA7B3130D4DD200630303030369D3030DA7B31303030300130303030A6A8303012D1A59C303030303030DA7B313076D5E0E930303030509430303030"}
            }
        },
        {
            "Hex Editor(data)[quickcpy++]",
            {
                {0xe9e0, "10E3420701000CE3F0F502000000000000000000000000002E62010010E3DA83A89F00005CA000009498020000000000706101003E9D00002F0090C700003E9D00000400D44B01003E9D0000A700F4FC010066E3D44B0100084002000000000000000000741F020070610100F4FC01004000868C020098E3000090C700003E9D0000A800D44B0100084002000000000000000000741F020042E63E9D00000000A09C000044E60F00AE1B0200CC61010016390100D64B0100520B020000000000D20302003E9D000044E690C700003E9D00003800F4FC0100EEE3D44B0100084002000000000000000000741F020040E63E9D00000000A09C00001AE40000A59C000000000200B03A01000100800E010044E6000052E5361602000000BC6E01000000741F020042E63E9D00000100A09C000000000000B03A0100FAE5741F020086E4D64B0100A59C000000000000F4FC01001FFC18960100A89F00005CA000003E9D0000C400F4FC010080E4D44B0100084002000000000000000000741F0200C8E43E9D00000000A59C000000000000F4FC01001EFC18960100A89F00005CA000003E9D00006800F4FC0100C2E4D44B0100084002000000000000000000741F020000003E9D00000000F4FC010026FC18960100A89F00005CA000003E9D00000C00F4FC0100FAE4D44B0100084002000000000000000000741F0200B03A010002E6741F020040E63E9D00000000A09C00000000000030BF0000084002000000000000000000741F020040E63E9D00000100A09C000000000000B03A010052E5741F020040E63E9D0000FFFFA09C000042E642E63E9D00000000A59C000040E600003E9D00000000A09C0000BEE50000A59C00000000000030BF000070610100FA3F02000000000000000000A89F00005CA00000E6C1000000004EE6A59C000000000000EAED010050E600000000D64B0100A59C00005AE600006A21010000007482010010400200D64B0100A59C0000000000002E620100D4DD0006369D00002E620100050548E6808F00002E620100052553E6808F00007E9400008075010000052000865301003C9F00005CA0000048A2000032E63E9D00000100A59C000000000000A5300100400360E600E3000032890E000000B03A010000E3741F020051D5000000000000416464723A20000000000056616C75653A20000000000000"}
            }
        },
        {
            "Hex Editor(launcher)[124an,small font]",
            {
                {0xd180, "303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030A89F3030E0A03030A53031306003E0E930E33030186E3130328931303030A53031304003E0E960E601E3328931303030741F3230"}
            }
        },
        {
            "Tetris[Hex Editor]",
            {
                {0xd552, "2E62313050E7D0D65094303090022E62313070D1F0E7B03A313054D50A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A393130509430303030000000000000000000000000000000000000"},
                {0xd700, "BCDAA89F30305CA030303E9D30301EE4A49C3030BCDABCDA3E9D30300200A09C3030CAE73030A49C30303030303030BF3030706131303E9D30300004A09C3030303030302E6231305EE5000090C730303E9D30305800F4FC313096E7D44B3130084032303030303030303030741F3230A430313000000A0020FEF0D4741F32306A21313086D134AC3030EEF53230F8DA303040D23030A4303130D3E3D3E330300130C8033230800E3130C0DC000030302E62313010300000A49C3030F4DA3030A49C303086D13030A09C30300CD93030509930300000AE1B32306AD3303048D2A49C30303030303030BF3030706131303E9D30300000A09C303046D23030A49C3030303030306A213130F8DA90C730307061313030BF30303E9D3030F0DA90C73030C2A531303E9D3030B600D44B3130084032303030303030303030741F3230F4DAA43031300000000000007ED65094303004002E623130C0DAFADA509430300400CC033230A09C3030FADA3030A09C3030F8DA30303E9D30300000A09C3030FCDA3030A09C30306AD830303E9D30309ED2A49C303030303030741F32306AD82E623130FADAC0DA509430300400A43031307ED6FEEC3030BCD75094303000023E9D3030F8D5A49C303030303030741F3230CADA3E9D3030FEDAA49C303030303030A4303130D4DD0006C8D888D8369D3030741F3230F0DA3E9D30300000A09C30307AD3303030BF30303E9D3030B6DA389930302E6231307010B0DA808F30307E943030A43031300A00010084D33030CC033230A49C3030EEDA3030A09C30303030303090C730303E9D30301000D44B31300840323030303030303030302E6200000000000000000000000000000000"},
                {0xd980, "F6DAFCFFF2DAF8FF000000000000000000000000000000000000000000000000000000000000000000000000F2DA0000F6DA000000003C040000000000000000F2DA0800F6DA040000000000000000000400000404040804040004040804040800040404080404080400000404040408000000040404080400000400000400080000040008000804040004040008040808000004040408040000000400080408000004000800000400000400040404080000040004040804040000040404000800000400040408040400000404040008040008000004040400000004040404080400080000040404000000040404040800000400000404040000040000040404000004000004040400000400000404040000040008000C00040004040408040C0000040008000C00040004040408040C73636F72653A000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000F2DA0000F6DA000000003C04D0D9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003040344038403C404040444048404C40504054402C002C042C082C0C2C102C142C182C1C2C202C242C282C2C2C302C342C382C3C580058045808580C581058145818581C582058245828582C583058345838583C2727272727272727272727272727272727272727000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101018080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808080808000000000000000000000000000000000"},
                {0xe9e0, "3130303000E8223631300000000000000000F4FC313080D13289FA050000CC033230741F3230B03A31307ED1741F323000000000EEDA3E9D30300000A49C3030FCDA30303E9D30300004A09C30306AD830303E9D3030CAD3A49C303030303030B03A31307ED6741F3230C8DA3E9D3030FEDAA49C3030C8DAC8DA3E9D30300200A09C30308CD53030A49C30303030303030BF3030706131302E623130020000FCA09C30307ED43030A49C30308CD43030B03A31300100800E3130C0DC303030305099303030306A213130FF00509930303030A49C3030F4E73030A49C30301ED53030A49C30303030303016393130D64B3130520B323066D43030A49C3030E0D83030F4FC313000003E9D30300900D44B3130A81B3230706131303E9D30300000A49C30309EDA30306A2131300000A81B3230706131303E9D30300100A09C30303030303030BF30303E9D3030090090C730303E9D30308200F4FC3130D2D4D44B3130084032303030303030303030741F3230D0FF2E62313020E408DB509430304001B03A313080E7741F323000000000D0FFD44B31303E9D303020E4F4FC31301CDB32893130D0DA2E62313000E4CEDA509430302000CC0332302E623130000000E4A81B32303289313030302E62313008DB9CDC5094303014006AD33030CEDAA49C3030F0DA30303E9D30300100A09C30307ED57ED5A430313030303130D8D33030A49C3030303030302236313000000000000000003E9D303058EA32890A000000CC0332302E62313006DB06DB90C730303E9D30300200D44B31303E9D3030F200F4FC3130D8D3D44B313008403230303030303030BE03741F323000DB3E9D30300000A09C30303030303030BF30306A213130000490C730303E9D30302600F4FC3130F8D5D44B3130084032303030303030303030741F32302E62313008DB27303A9D303040012E623130CEDA88D9509430303000CC0332306AD33030CCDA3E9D30300200A09C30303030303030BF3030706131302E62313007000000A09C3030FEDA30305099303030303E9D30302000F4FC3130A0D3D44B3130D64B3130A49C303030303030A4303130FADAB4D93030BCD7509430300400741F3230FADA3E9D30300000A09C3030FEDA30306A2131302000B03A31300100800E3130C0DC000000005099303000003E9D30300000A09C3030FCDA303048893130D64B31306A21313000DB509430300800CC033230A09C303000DB303030BF3030F4FC31300000A09C303002DB3030D64B3130A09C303004DB3030D64B3130A09C303006DB3030D64B3130A09C3030C4DA30303E9D303006DBA49C3030C4DAC4DA3E9D30300200A09C303026D83030A49C30303030303030BF3030706131303E9D30300000A09C30308ED73030A49C3030C6DA30303E9D3030FEDAA49C3030C6DAC6DA3E9D30300200A09C3030FAD73030A49C30303030303030BF3030706131303E9D30300000A09C303030303030F4FC3130000018963130A89F30305CA030303E9D30307230F4FC3130F2D7D44B3130084032303030303030303030741F3230DAD7A43031303030313080D17ED6A49C30306AD830303E9D303000E83289000030303E9D3030F8D5A49C303030303030A89F3030741F32302E62313006DB000090C730303E9D3030C200F4FC31305CD7D44B3130084032303030303030303030741F32302E6231309ADC000090C730303E9D30300200F4FC31300000D44B31303E9D3030A000F4FC31301AD7D44B3130084032303030303030303030741F3230B03A3130D2D2741F3230B03A3130F8D5741F323070707070030000000404D3E33118CADA303030303030C8D8CADAA89F30305CA030302E62313048DC0200A09C3030C8D83030A49C30303030303090C730303E9D30305200D44B3130084032303030303030303030741F323000003E9D30300000A09C303006D93030A49C303018D930303E9D3030D290A49C30301AD930303E9D30300000A49C303074D83030A43031300000030004000000A49C3030303030303007323070D87ED8D2903030860E31300800280030073230E0DC3CD9D29030308080400000000800D3E331183030303020DD58D901005900D29030308080400000000107D3E33118303030303030B03A3130F6D22E623130D3E3D3E3C8033230741F323000000000"}
            }
        },
        {
            "Snake[124an]",
            {
                {0xd180, "3030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030302E62313034D5E0E90A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A3931300A393130509430303030"},
                {0xd9f0, "A4EEFDFFA4EE00FD0000000000000000AEEEA4EE03000600B6EEBCEE00000909090A090B0C090C0A0C0B0C090C0A0C0BC6D90000000000000000000000000000A4EE0003A4EE0300"},
                {0xe9e0, "F4FC3130200034AC3030A0AD30303AD53030303030302E623130D3E3D3E3C8033230A43031301030000030300130800E313030D530303030A09C30307CD93030509930303030AE1B323030BF3030706131303E9D30300000A09C30303030303014393130D64B5104520B3230AAEE30305094303004003E9D30300000A09C3030303030304AD030303030706131303E9D30300000A09C3030DCD53030A49C3030ACEE3030F4FC313030303E9D30300000A09C3030303030304AD030303030706131303E9D30300000A09C30303030303018963130F4FC31300000D64B3130CC0332303E9D30303030F4FC313036D6D44B3130084032303030303030303030741F3230A8EEA430313030300000303062D7A09C30303030303030BF30303E9D3030B6EEF4FC3130B0EE328931303030741F3230ACEE2E62313006000600A09C303000D73030A49C3030DCD63030A49C30301CD73030A49C30303030303048893130706131303E9D3030C6D9A49C3030AAEE30303E9D30300600A09C3030A8EE30303E9D30300600A09C3030A0EE3030A09C30303030303030BF3030706131303E9D30300000A09C3030303030306A2131303330B03A31300130800E313030D530300130509930303030800E31303030300030306A21313015305099303002303E9D3030D0CFA09C30303030303030BF30304889313048893130D64B313086533130A49C303000013030AE1B3230D84B313070613130A49C303000013030AE1B3230D84B313070613130A49C3030AAEEAAEEA43031303030000002003030CC033230A09C3030A6EE303030BF30303E9D30300000A09C30303030303070613130A09C303000013030AE1B3230D84B313070613130A49C303000013030AE1B3230D84B313070613130A49C30300000303030BF30306A213130C04090C73030AC1B3230706131306A213130C00090C73030C2A531303E9D30300230F4FC31300000D44B31303E9D3030DF30F4FC313014D8D44B3130084032303030303030303030741F3230A4303130D4DD2006F6D83030369D3030B03A31309ED8741FA2EE7E9430303E9D3030AEEEA49C30306CD86CD83E9D30303130A49C3030303030302E6231303030E0E9223631303030303030303030F4FC313034D53289820130302E623130D3E3D3E3C8033230B03A313032D5741F32300000E0E0303130300305D3E33118A2EE303030303030F6D8A2EE3E9D30300200A09C3030AAEE30306A21313020D9509430300200CC033230A09C3030A2EE303030BF30303E9D30300000A09C30303030303090C730303E9D30305E30D44B3130084032303030303030303030741F3230AAEE3E9D30300000A09C30303030303030BF3030706131303E9D30300000A09C303030303030F4FC3130303018963130F4FC31300000D64B3130CC0332303E9D30307E30F4FC313054D9D44B3130084032303030303030303030741F323020D9A43031307ED9000088D83030A09C303030303030DAAB3230084032303030303030303030741F3230303030BF303008403230B4D93030303030302E62313030303130A49C3030303030302236313030303030303030303E9D303034ED32893A000300620D323094D83616323088D8D2903030B03A31302ED8741F323000002E623130A2EE00DA509430303000B03A313040D8741F323"},
                {0xeea0, "A6D9AEEEA4EE03000600B6EEBCEE00000909090A090B0C090C0A0C0B0C090C0A0C0BC6D9"},
            }
        },
        {
            "LC E9E0 TEST[110an]",
            {
                {0xd180, "30303030303030303030303030303030303030303030303030303030303030303030785c3130dee9600d3248"}
            }
        }
    };

    if (ImGui::BeginTabBar("InjectorTabs", ImGuiTabBarFlags_None)) {
        if (ImGui::BeginTabItem("Input")) {
            ImGui::BeginChild("Input", ImVec2(0, ImGui::GetWindowHeight() * 0.4));
            editor.DrawContents(data_buf, range);
            ImGui::EndChild();

            ImGui::SliderInt(
#if LANGUAGE == 2
                "输入内容大小"
#else
                "Input Size"
#endif
                , &range, 64, 1024);

            if (ImGui::Button(
#if LANGUAGE == 2
                    "加载数据到输入区"
#else
                    "Load to input area"
#endif
                    )) {
                memcpy(base_addr + inputbase, data_buf, range);
                info_msg = "Data loaded";
                show_info_popup = true;
            }

            ImGui::Separator();

            ImGui::Text(
#if LANGUAGE == 2
                "an前数字"
#else
                "x an"
#endif
            );
            ImGui::SameLine();
            ImGui::InputText("##off", buf, 9);
            ImGui::SameLine();
            if (ImGui::Button(
#if LANGUAGE == 2
                    "输入 an"
#else
                    "Input \"an\""
#endif
                    )) {
                int off = atoi(buf);
                if (off > 100) {
                    memset(base_addr + inputbase, 0x31, 100);
                    memset(base_addr + inputbase + 100, 0xa6, 1);
                    memset(base_addr + inputbase + 101, 0x31, off - 100);
                }
                else {
                    memset(base_addr + inputbase, 0x31, off);
                }
                *(base_addr + inputbase + off) = 0xfd;
                *(base_addr + inputbase + off + 1) = 0x20;
#if LANGUAGE == 2
                info_msg = "\"an\" 已输入";
#else
                info_msg = "\"an\" Inputed";
#endif
                show_info_popup = true;
            }

            ImGui::EndTabItem();
        }

        if (ImGui::BeginTabItem("Inject")) {
            if (ImGui::Button("Add Inject Entry")) {
                injectEntries.push_back(InjectEntry());
            }

            for (size_t i = 0; i < injectEntries.size(); ++i) {
                ImGui::PushID(static_cast<int>(i));

                ImGui::SetNextItemWidth(UI::Scaling::minColumnWidth);

                ImGui::InputText("Inject addr", injectEntries[i].address, 10);

                ImGui::SameLine();
                if (ImGui::Button("Paste")) {
                    const char* clipboard_text = ImGui::GetClipboardText();
                    if (clipboard_text) {
                        strncpy(injectEntries[i].hexData, clipboard_text, sizeof(injectEntries[i].hexData) - 1);
                        injectEntries[i].hexData[sizeof(injectEntries[i].hexData) - 1] = '\0';
                        info_msg = "Hex data pasted from clipboard";
                        show_info_popup = true;
                    } else {
                        info_msg = "Failed to paste from clipboard";
                        show_info_popup = true;
                    }
                }

                ImGui::InputTextMultiline("## hex", injectEntries[i].hexData, IM_ARRAYSIZE(injectEntries[i].hexData) - 1);

                if (ImGui::Button("Inject hex")) {
                    auto plc = strtol(injectEntries[i].address, 0, 16);
                    auto valid_hex = [](char c) {
                        return (c >= '0' && c <= '9') || (c >= 'a' && c <= 'f') || (c >= 'A' && c <= 'F');
                    };
                    size_t j = 0, k = 0;
                    char hex_buf[3];
                    while (injectEntries[i].hexData[j] != '\0' && injectEntries[i].hexData[j + 1] != '\0') {
                        if (injectEntries[i].hexData[j] == ';' || injectEntries[i].hexData[j + 1] == ';') {
                            for (;; ++j) {
                                if (injectEntries[i].hexData[j] == '\0')
                                    goto exit;
                                if (injectEntries[i].hexData[j] == '\n') {
                                    ++j;
                                    break;
                                }
                            }
                        }
                        else {
                            if (!(valid_hex(injectEntries[i].hexData[j]) && valid_hex(injectEntries[i].hexData[j + 1]))) {
                                ++j;
                                continue;
                            }
                            hex_buf[0] = injectEntries[i].hexData[j];
                            hex_buf[1] = injectEntries[i].hexData[j + 1];
                            hex_buf[2] = '\0';
                            uint8_t byte = strtoul(hex_buf, nullptr, 16);
                            me_mmu->WriteData(plc + k, byte);
                            j += 2;
                            ++k;
                        }
                    }
                exit:
                    info_msg = "Injected successfully";
                    show_info_popup = true;
                }

                ImGui::SameLine();
                if (ImGui::Button("Remove")) {
                    injectEntries.erase(injectEntries.begin() + i);
                    --i;
                }

                ImGui::Separator();
                ImGui::PopID();
            }

            ImGui::EndTabItem();
        }

        if (ImGui::BeginTabItem("fx580vnx")) {
            for (const auto& preset : presets) {
                if (ImGui::Button(preset.name)) {
                    for (const auto& inject : preset.injects) {
                        auto plc = inject.first;
                        const auto& hexData = inject.second;

                        auto valid_hex = [](char c) {
                            return (c >= '0' && c <= '9') || (c >= 'a' && c <= 'f') || (c >= 'A' && c <= 'F');
                        };

                        size_t j = 0, k = 0;
                        char hex_buf[3];
                        while (j < hexData.length() - 1) {
                            if (hexData[j] == ' ') {
                                ++j;
                                continue;
                            }
                            if (!(valid_hex(hexData[j]) && valid_hex(hexData[j + 1]))) {
                                ++j;
                                continue;
                            }
                            hex_buf[0] = hexData[j];
                            hex_buf[1] = hexData[j + 1];
                            hex_buf[2] = '\0';
                            uint8_t byte = strtoul(hex_buf, nullptr, 16);
                            me_mmu->WriteData(plc + k, byte);
                            j += 2;
                            ++k;
                        }
                    }
                    info_msg = "Injected successfully";
                    show_info_popup = true;
                }
                ImGui::SameLine();
                ImGui::Text("Inject to %X", preset.injects[0].first);
            }
            ImGui::EndTabItem();
        }

        ImGui::EndTabBar();
    }

    if (show_info_popup) {
        ImGui::OpenPopup("info");
        show_info_popup = false;
    }

    if (ImGui::BeginPopupModal("info", nullptr, ImGuiWindowFlags_AlwaysAutoResize)) {
        ImGui::Text("%s", info_msg);
        if (ImGui::Button(
#if LANGUAGE == 2
                "好的"
#else
                "Ok"
#endif
                )) {
            ImGui::CloseCurrentPopup();
        }
        ImGui::EndPopup();
    }
}